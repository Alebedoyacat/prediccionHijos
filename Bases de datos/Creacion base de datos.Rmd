---
title: "Creación base de datos"
author: "Alejandro Bedoya Cataño"
date: "26/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Carga de librerías

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(dplyr)
```


# Carga de las bases de datos

Bases de datos que contienen las variables 'definitivas' a utilizar.

```{r}
#setwd()  #Pa que definan la ruta de su directorio
educacion <- read.csv("Educación.csv",sep = ";", dec = ",")
fuerza_trabajo <- read.csv("Fuerza de trabajo.csv", sep = ";", dec = ",")
compo_hogar <- read.csv("Caracteristicas y composicion del hogar.csv", sep=";", dec=",")
datos_vivienda <- read.csv('Datos de la vivienda.csv', sep = ";", dec = ",")
uso_energetico <- read.csv('Uso de energéticos del hogar.csv', sep=";", dec = ",")
servi_hogar <- read.csv('Servicios del hogar.csv', sep = ";", dec = ",")
salud <- read.csv('Salud.csv', sep = ';', dec = ",")
```

**Renombrando los directorios:**

```{r}
colnames(compo_hogar)[1] <- "DIRECTORIO"
colnames(educacion)[1] <- "DIRECTORIO"
colnames(fuerza_trabajo)[1] <- "DIRECTORIO"
colnames(datos_vivienda)[1] <- "DIRECTORIO"
colnames(uso_energetico)[1] <- "DIRECTORIO"
colnames(servi_hogar)[1] <- 'DIRECTORIO'
colnames(salud)[1] <- 'DIRECTORIO'
```

# Creación identificador único: clave

```{r}
compo_hogar$clave <- paste0(compo_hogar$DIRECTORIO, compo_hogar$SECUENCIA_P)
educacion$clave <- paste0(educacion$DIRECTORIO, educacion$SECUENCIA_P)
fuerza_trabajo$clave <- paste0(fuerza_trabajo$DIRECTORIO, fuerza_trabajo$SECUENCIA_P)
datos_vivienda$clave <- paste0(datos_vivienda$DIRECTORIO, datos_vivienda$SECUENCIA_P)
salud$clave <- paste0(salud$DIRECTORIO, salud$SECUENCIA_P)
```

Intercambio de nombres para la base de datos servicios hogar

```{r}
colnames(servi_hogar)[3] <- 'ORDEN'
colnames(servi_hogar)[4] <- 'SECUENCIA_P'
colnames(uso_energetico)[3] <- 'ORDEN'
colnames(uso_energetico)[4] <- 'SECUENCIA_P'
servi_hogar$clave <- paste0(servi_hogar$DIRECTORIO, servi_hogar$SECUENCIA_P)
uso_energetico$clave <- paste0(uso_energetico$DIRECTORIO, uso_energetico$SECUENCIA_P)
```



# Calculo del total de hijos para cada hogar

```{r}
#Se seleccionan las columnas directorio y P6051

clave_P6051 <- compo_hogar %>% dplyr::select(clave, P6051)
#Se cuentan el numero de hijos por hogar
hijos_hogar <- clave_P6051 %>% filter(P6051 == 3) %>% count(clave)
colnames(hijos_hogar)[2] <- "Hijos"
nrow(hijos_hogar)
```



```{r}
#Se filtra el parentezco dejando solo a los jefes de hogar
jefe_hogar <- compo_hogar %>% filter(P6051 == 1)

#Se asocian los hijos a cada jefe de hogar
hijos_jefe <- merge(jefe_hogar, hijos_hogar, by = "clave", all.x = TRUE)

#A los jefe de hogar sin hijos se les establecen cero hijos
hijos_jefe$Hijos[is.na(hijos_jefe$Hijos)] <- 0

nrow(hijos_hogar)
nrow(hijos_jefe)
```


# Filtración - cabezas de familia 

Se reducirá cada base de datos inicial a sólo los registros que consideren 

```{r}
educacion %>% 
  filter(ORDEN==1) -> edu_filtrada; nrow(edu_filtrada)
fuerza_trabajo %>% 
  filter(ORDEN==1) -> fuerza_trabajo_filtrada; nrow(fuerza_trabajo_filtrada)
compo_hogar %>% 
  filter(ORDEN==1) -> compo_hogar_filtrada; nrow (compo_hogar_filtrada)
uso_energetico %>% 
  filter(ORDEN==1) -> uso_energetico_filtrada; nrow(uso_energetico_filtrada)
servi_hogar %>%
  filter(ORDEN==1) -> servi_hogar_filtrada; nrow(servi_hogar_filtrada)
salud %>% 
  filter(ORDEN==1) -> salud_filtrada; nrow(salud_filtrada)
```


# Union de todas las bases 

```{r}
BASE_FINAL <- Reduce(function(x, y) merge(x, y, all.x = TRUE), list(hijos_jefe,
                                                                    edu_filtrada,
                                                                fuerza_trabajo_filtrada,
                                                                servi_hogar_filtrada,
                                                                uso_energetico_filtrada,
                                                                salud_filtrada))
BASE_FINAL %>% 
  relocate(Hijos, .after = 'DIRECTORIO') -> BASE_FINAL
```


```{r}
BASE_FINAL <- merge(x = datos_vivienda, y = BASE_FINAL, by = 'DIRECTORIO', all.y = TRUE)
```


# Filtro de variables y adición de nuevas

Se filtra para tener únicamente las variables pre analizadas y elegidas

```{r}
variables_definitivas <- c('DIRECTORIO','clave.x','Hijos','P8587','P8586','P6435',
                           'P5000','P5024','P5502','P5013S1','I_HOGAR','PERCAPITA',
                           'I_OU','CANT_PERSONAS_HOGAR', 'P5018',
                           'P1070','P6020', 'P6071','P6040', 'P6127', "P6100")

```


```{r}
#creando Edad conyugue
compo_hogar %>% 
  filter(P6051==2) %>% 
  dplyr::select(clave,P6040) -> edad_conyugue 
colnames(edad_conyugue)[2] <- 'edad_conyugue'
```

```{r}
#creando Edad máxima entre los padres
ed_max <- compo_hogar %>% filter(P6051==1 | P6051==2) %>% group_by(clave) %>% mutate(edad_maxima=max(P6040)) %>% select(clave, edad_maxima, P6051)
ed_max<- ed_max %>% filter(P6051==1) %>% select(clave, edad_maxima)
```

```{r}
#creando El cabeza de hogar vive con pareja? 1.Si y 2.No
pareja<- compo_hogar %>% filter(P6051==1) %>% select(clave, P6071)
pareja$P6071[is.na(pareja$P6071)]<-2
colnames(pareja)[2]<-"con_pareja"
```

```{r}
BASE_FINAL %>% 
  dplyr::select(all_of(variables_definitivas)) -> BASE_FILTRADA 
```

```{r}
colnames(BASE_FILTRADA)[2] <- 'clave' 
#BASE_FILTRADA <- merge(x = BASE_FILTRADA, y = edad_conyugue, all.x = TRUE, by = 'clave')
#BASE_FILTRADA <- merge(x = BASE_FILTRADA, y = ed_max, all.x = TRUE)
#BASE_FILTRADA <- merge(x = BASE_FILTRADA, y = pareja, all.x = TRUE, by = 'clave')
#BASE_FILTRADA$edad_conyugue[is.na(BASE_FILTRADA$edad_conyugue)] <- 0
#BASE_FILTRADA$edad_maxima[is.na(BASE_FILTRADA$edad_maxima)] <- BASE_FILTRADA$P6040
#BASE_FILTRADA$con_pareja[is.na(BASE_FILTRADA$con_pareja)] <- BASE_FILTRADA$P6071
BASE_FILTRADA <- Reduce(function(x, y) merge(x, y, all.x = TRUE), list(BASE_FILTRADA,
                                                                       edad_conyugue,
                                                                       ed_max,
                                                                       pareja))
BASE_FILTRADA$edad_conyugue[is.na(BASE_FILTRADA$edad_conyugue)] <- 0
BASE_FILTRADA$edad_maxima[is.na(BASE_FILTRADA$edad_maxima)] <- BASE_FILTRADA$P6040
BASE_FILTRADA$con_pareja[is.na(BASE_FILTRADA$con_pareja)] <- BASE_FILTRADA$P6071
```



# Creación del archivo - BASE_FINAL.csv

```{r}
write.csv(BASE_FINAL, file = 'BASE_FINAL.csv')
```


```{r}
write.csv(BASE_FILTRADA, file = 'BASE_FILTRADA.csv')
```

**OJOOO: CORRER SOLO UNA VEZ, YO VERÉ**

```{r}
BASE_FILTRADA <- subset(BASE_FILTRADA, select = -c(clave, DIRECTORIO))
nombres <- c("Hijos","nivel_edu","estu_actual","tipo_trabajo","num_cuartos","num_sanitarios","estado_civil","comidas_dia","I_HOGAR","PERCAPITA","I_OU","CANT_PERSONAS_HOGAR", "consumo_energia","tipo_vivienda","sexo","conyugue_hogar","edad_jefe","estado_salud","regimen_salud","edad_conyugue","edad_maxima","con_pareja")
length(nombres)
colnames(BASE_FILTRADA) <- nombres
colnames(BASE_FILTRADA)
```

# Dealing with NA's

A continuación se presenta la etapa de preprocesamiento para los NA's a portas de la partición en subconjuntos. 

**Inputación a categorías no sabe/ no responde**

```{r}
#A conyugues sin edad, pongale la edad del jefe
BASE_FILTRADA$edad_conyugue[BASE_FILTRADA$edad_conyugue==0] <- BASE_FILTRADA$edad_jefe[BASE_FILTRADA$edad_conyugue==0]
# NA's en regimen salud cree la categoría 0
BASE_FILTRADA$regimen_salud[is.na(BASE_FILTRADA$regimen_salud)] <- 9
# NA's en si el conyugue vive en el hogar, cree la categoría 0
BASE_FILTRADA$conyugue_hogar[is.na(BASE_FILTRADA$conyugue_hogar)] <- 0
# NA's en tipo de trabajo
BASE_FILTRADA$tipo_trabajo[is.na(BASE_FILTRADA$tipo_trabajo)] <- 0

sum(is.na(BASE_FILTRADA$edad_conyugue))
sum(is.na(BASE_FILTRADA$regimen_salud))
sum(is.na(BASE_FILTRADA$conyugue_hogar))
sum(is.na(BASE_FILTRADA$tipo_trabajo))
```

```{r message=FALSE, warning=FALSE}
library(caret)
```

```{r}
####### veamos ahora como llenar comidas dia
summary(as.factor(BASE_FILTRADA$comidas_dia))
mean(na.omit(BASE_FILTRADA$comidas_dia)) 
nas_comidas <- which(is.na(BASE_FILTRADA$comidas_dia))
set.seed(123)
particion <- createDataPartition(nas_comidas, p=0.5, list = FALSE)
nas_comidas1 <- nas_comidas[particion]
nas_comidas2 <- nas_comidas[-particion]
BASE_FILTRADA$comidas_dia[nas_comidas1] <- 3
BASE_FILTRADA$comidas_dia[nas_comidas2] <- 2
summary(as.factor(BASE_FILTRADA$comidas_dia)) #Lista la comida
sum(is.na(BASE_FILTRADA$comidas_dia))
```

Anteriores 585

```{r}
sum(is.na(BASE_FILTRADA$I_HOGAR))
sum(is.na(BASE_FILTRADA$num_cuartos))
sum(is.na(BASE_FILTRADA$PERCAPITA))
sum(is.na(BASE_FILTRADA$I_OU))
sum(is.na(BASE_FILTRADA$CANT_PERSONAS_HOGAR))

sum(is.na(BASE_FILTRADA$I_HOGAR==BASE_FILTRADA$num_cuartos & 
            BASE_FILTRADA$I_HOGAR==BASE_FILTRADA$num_cuartos &
            BASE_FILTRADA$I_HOGAR==BASE_FILTRADA$PERCAPITA &
            BASE_FILTRADA$I_HOGAR==BASE_FILTRADA$I_OU &
            BASE_FILTRADA$I_HOGAR==BASE_FILTRADA$CANT_PERSONAS_HOGAR))
nas_833 <- which(is.na(BASE_FILTRADA$I_HOGAR))
BASE_FILTRADA <- BASE_FILTRADA[-nas_833,]
sum(is.na(BASE_FILTRADA$I_HOGAR))
```

Para consumo de energía

```{r}
sum(is.na(BASE_FILTRADA$consumo_energia))
summary(BASE_FILTRADA$consumo_energia)
nas_energia <- which(is.na(BASE_FILTRADA$consumo_energia))
median(na.omit(BASE_FILTRADA$consumo_energia))
BASE_FILTRADA$consumo_energia[nas_energia] <- median(na.omit(BASE_FILTRADA$consumo_energia))
sum(is.na(BASE_FILTRADA$consumo_energia))
```

Las "no tienen"

```{r}
# NA's estado civil no tiene
sum(is.na(BASE_FILTRADA$estado_civil))
# NA' tipo de vivienda
sum(is.na(BASE_FILTRADA$tipo_vivienda))
# NA'S sexo
sum(is.na(BASE_FILTRADA$sexo))
# NA'S conyugue hogar
sum(is.na(BASE_FILTRADA$conyugue_hogar))
# NA'S estado salud
sum(is.na(BASE_FILTRADA$estado_salud))
# NA'S regimen salud
sum(is.na(BASE_FILTRADA$regimen_salud))
```

Número de sanitarios

```{r}
# NA'S num_sanitarios
sum(is.na(BASE_FILTRADA$num_sanitarios))
summary(as.factor(BASE_FILTRADA$num_sanitarios))

BASE_FILTRADA$num_sanitarios[is.na(BASE_FILTRADA$num_sanitarios)] <- 1
sum(is.na(BASE_FILTRADA$num_sanitarios))
```

Nivel educativo maximo

```{r}
#NA'S nivel_educativa
sum(is.na(BASE_FILTRADA$nivel_edu))
summary(as.factor(BASE_FILTRADA$nivel_edu))
BASE_FILTRADA$nivel_edu[is.na(BASE_FILTRADA$nivel_edu)] <- 3 #moda
sum(is.na(BASE_FILTRADA$nivel_edu))
```

```{r}
summary(BASE_FILTRADA)
```

```{r}
write.csv(BASE_FILTRADA, file = 'BASE_FILTRADA(sin_nas).csv')
```

# Particion entrenamiento y prueba

```{r message=FALSE, warning=FALSE}
set.seed(123)
library(caret)
inTrain <- createDataPartition(y=BASE_FILTRADA$Hijos, p=0.70, list = FALSE)
train <- BASE_FILTRADA[inTrain,]
test <- BASE_FILTRADA[-inTrain,]
dim(train)
dim(test)
```

# Renombrando las variables en las bases de datos

```{r}
names(train)
names(test)
```


```{r}
write.csv(train, file = 'train.csv')
write.csv(test, file = 'test.csv')
```












































